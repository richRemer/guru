#!/bin/bash -e

declare exe=guru
declare cmdname=
declare color_reset="\e[0m"
declare color_green="\e[92;1m"
declare color_bold="\e[1m"

detect-color () {
    local colors=$(tput colors 2>/dev/null)

    if test $? -ne 0 -o "$colors" -le 2; then
        disable-color
    fi
}

disable-color () {
    color_reset=""
    color_green=""
    color_bold=""
}

error () {
    local status=${2:-1}
    echo "$exe: $1" >&2
    return $status
}

guru-install () {
    local -a pkgs=("$@")
    local pkg

    if test ${#pkgs[@]} -eq 0; then
        pkgs=(.)
    fi

    for pkg in "${pkgs[@]}"; do
        pkg-fetch "$pkg"
    done

    for pkg in "${pkgs[@]}"; do
        pkg-install "$pkg"
    done
}

list-commands () {
    echo "Commands recognized:"
    compgen -c | grep ^$exe- | cut -d- -f2- | sed -e "s/^/  $exe /"
}

pkg-fetch () {
    local pkg_spec="$1"

    if grep -qP ^https?: <<< "$pkg_spec"; then
        error "remote package '$pkg_spec' not supported"
    elif grep -qP ^github: <<< "$pkg_spec"; then
        error "GitHub package '$pkg_spec' not supported"
    elif ! test -d "$pkg_spec"; then
        error "specified package '$pkg_spec' is not a directory"
    else
        pkg-verify "$pkg_spec"
    fi
}

pkg-install () {
    local pkg_root="$1"
    local pkg_spec=${2:-$(basename $(realpath "$pkg_root"))}

    echo -e "${color_green}installing $pkg_spec${color_reset}"
    pkg-install-apt "$pkg_root" "$pkg_spec"
    pkg-install-bin "$pkg_root" "$pkg_spec"
    echo -e "${color_bold}completed installing $pkg_spec${color_reset}"
}

pkg-install-apt () {
    local pkg_root="$1"
    local pkg_spec=${2:-$(basename $(realpath "$pkg_root"))}

    if ! test -f "$pkg_root/apt"; then
        return
    fi

    echo -e "${color_bold}installing system dependencies with APT${color_reset}"
    DEBIAN_FRONTEND=noninteractive apt-get install -y \
        $(strip-comments < "$pkg_root/apt")
}

pkg-install-bin () {
    local pkg_root="$1"
    local pkg_spec=${2:-$(basename $(realpath "$pkg_root"))}

    if ! test -d "$pkg_root/bin"; then
        return
    fi

    echo -e "${color_bold}installing binaries${color_reset}"
    cp -vrT "$pkg_root/bin" /usr/local/bin
}

pkg-verify () {
    local pkg_root="$1"
    local pkg_spec=${2:-$(basename $(realpath "$pkg_root"))}

    if ! test -f "$pkg_root/version"; then
        error "'$pkg_spec' is not a valid package"
    fi
}

strip-comments () {
    grep -v ^\#
}

usage () {
    echo "Usage:"
    echo "  $exe [<options>]"
    echo "  $exe [<options>] <command> [<command-opts>]"
    echo
    echo "Options recognized:"
    echo "  --help      Show this help message."
    echo "  --list      List available commands."
    echo "  --no-color  Disable color output."
}

eval set -- $(getopt -o "" --long help,list,no-color -n $exe -- "$@")

while true; do
    case "$1" in
        --help)     usage;          exit;;
        --list)     list-commands;  exit;;
        --no-color) disable-color;;
        --)         shift;          break;;
        *)                          break;;
    esac
done

cmdname="$1"

if shift; then
    if type -p guru-"$cmdname" &>/dev/null; then
        detect-color
        guru-"$cmdname" "$@"
    else
        error "'$cmdname' is not a $exe command.  Try '$exe --help'."
    fi
else
    usage
    echo
    list-commands
fi
